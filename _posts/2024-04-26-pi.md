---
title: Self-hosted server (raspberry pi)
#authors: ["LS Flores", "MH Vainstein", "HCM Fernandes", "MA Amaral"]
#journal: "Journal of Theoretical Biology 524, 110737"
date: 2024-04-26 11:33:00 +0800
categories: []
tags: [raspberrypi]
pin: true
math: true
mermaid: true
#image:
#  path: /assets/img/pi.svg

---
<hr>

## Intro

The goal of this post is to show my Raspberry Pi setup. I use it mainly as a self-hosted server with Nextcloud to replace Google Drive. 

```
  Important: This setup does not need access to a router
```

The first thing is to intall raspberry OS 64bit lite on SSD (documentation [**here**](https://www.raspberrypi.com/documentation/computers/getting-started.html#install-using-imager){:target="_blank"})

Dont forget to enable ssh. If its not enabled you can add a empty file named ssh in the SSD boot folder.
	
  ```
  Important: dont use bookworm OS, use bulleye. 
  The former does not allow to config the wifi connection via the wpa_supplicant.conf in boot folder
```

## Wifi connection

Now we need to configure the Pi to be able to connect to a spefic Wifi.
On the SSD, inside the boot folder, create a file named wpa_supplicant.conf with your Wifi config as in

```conf
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=BR

# home wifi
network={
  ssid="wifi"
  psk=""
	key_mgmt=WPA-PSK
}

# eduroam
network={
	ssid="eduroam"
	key_mgmt=WPA-EAP
	eap=PEAP
	phase2="auth=MSCHAPV2"
	identity="username@ufrgs.br"
	password=""
}
```
  
## Pi config

With that the Pi is ready to boot, so connect the SSD on the Pi and try to ssh it.
Now run

```	
	sudo apt update
  sudo apt upgrade
```

with that we should be able to ssh using the hostname set in the OS installation. To be sure, or if you were not able to ssh using localhost name, install avahi daemon

```
  sudo apt-get install avahi-daemon
  sudo systemctl start avahi-daemon
  sudo systemctl enable avahi-daemon  
```

If you are using WSL on windows and cannot use hostname only inside WSL, you need to change (or create if doesnt exist) .wslconfig and write

```
  dnsTunneling=false
``` 

## Docker Compose

For the services on Pi we will install docker compose (see documentantion [**here**](https://docs.docker.com/desktop/install/linux-install/){:target="_blank"}) using the debian setup.

Now just create a folder and a docker compose file and thats it. We just have to modify the compose file to what we need.

```
	mkdir containers
		touch docker-compose.yml
```

### Docker Compose file

```yml
# run these
# docker compose pull && docker compose up -d
# commands inside container folder: docker compose exec folder_name command


version: "3.8"

# ----------------------
x-bb-common: &common
  networks:
    - internal
  restart: unless-stopped
#  deploy:
#    resources:
#      limits:
#        cpus: "3"
#        memory: 2560M

# ----------------------
networks:
  internal:
    external: false
    driver: bridge

services:

  db:
    image: mariadb:10.6
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    <<: *common

  # --- Nextcloud
  nextcloud:
    container_name: nextcloud
    image: nextcloud
    ports:
      - 8080:80
    volumes:
      - nextcloud:/var/www/html
      #- /home/lucasflores/nextcloud:/var/www/html/
      #- /home/lucasflores/nextcloud_data:/var/www/html/data
      #- /nextcloud_data:/var/www/html/data
      #- ./data:/var/www/html/data
    links:
      - db
    environment:
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db
      #- NEXTCLOUD_DATA_DIR=/var/www/html/data
    <<: *common


  # --- ZeroTier
  zerotier:
      image: zyclonite/zerotier
      container_name: zerotier-one
      devices:
        - /dev/net/tun
      network_mode: host
      volumes:
        - '/var/lib/zerotier-one:/var/lib/zerotier-one'
      cap_add:
        - NET_ADMIN
        - SYS_ADMIN
      restart: unless-stopped


  # --- pihole
  pihole:
    container_name: pihole
    hostname: skynet
    image: pihole/pihole:latest
    # For DHCP it is recommended to remove these ports and instead add: network_mode: "host"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      # - "67:67/udp" # Only required if you are using Pi-hole as your DHCP server
      - "8081:80/tcp"
    environment:
      TZ: "Europe/Berlin"
      WEBPASSWORD: "password"
      DNSMASQ_LISTENING: all
    # Volumes store your data between container upgrades
    volumes:
      - ./etc-pihole:/etc/pihole
      - ./etc-dnsmasq.d:/etc/dnsmasq.d
    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    # cap_add:
      # - NET_ADMIN # Required if you are using Pi-hole as your DHCP server, else not needed
    <<: *common

volumes:
  nextcloud:
  db:
```

## Services

### ZeroTier

ZeroTier is the responsible for the communication between devices. To have access to the Pi services we have to install it in all devices that we want to grant access.

if using wsl on windows, istall zerotier on wsl terminal
```
  curl -s https://install.zerotier.com | sudo bash
  sudo zerotier-cli join 9ecbaef5759219ad
```

Inside the ZeroTier website we have to create a network and then connect all devices to it.
The good thing about ZeroTier is that we can set static Ip's for all devices.
Once the devie is connected it must be approved in zerotier website


		
			

### Nextcloud

I wasnt able to change the storage folder for nextcloud. So Its important to know that the files are, by default, in

```
/var/lib/docker/volumes/containers_nextcloud/_data/data/username/files/
```

So, to make a backup of the files I run

```
  sudo rsync -avPn /var/lib/docker/volumes/containers_nextcloud/_data/data/username/files/ /home/user/nextcloud_backup 
	
  sudo rsync -chavzP --rsync-path="sudo rsync" --stats lucas@piip:/home/user/nextcloud_backup/ /home/nextcloud_backup
```

to backup inside pi and to backup to another machine, respectively. Im currently having some problemas with file permissions with the backup ones, but you always can make a copy and change that.

### Pihole

pi-hole (password:password) port/admin
steveblack adlist, change in pihole
update gravity

inside containers 
sudo touch etc-dnsmasq.d/02-local-dns.conf (pihole stuf)
address=/.local/ip   (zerotier ip) can use skynet.local:port instead of ip

change DNS server assignment to manual and put Zerotier pi ip (now everything passes through pi)

create a subnet (advanced-manage routes) with router pi ip (destination) and zerotier pi ip (via)
discover router pi ip with ssh and ip address